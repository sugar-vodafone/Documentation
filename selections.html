<html>
<head>
    <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.3.2/backbone-min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.runtime.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
    <script src="js/config.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <style>
        .selected {
            text-decoration: line-through
        }
        .selected img {
            -webkit-filter: blur(5px);
        }
        .link {
            text-decoration: underline;
            cursor: pointer;
        }
        .show-grid {
            margin-bottom: 15px;
        }
        .show-grid [class^=col-] {
            padding-top: 10px;
            padding-bottom: 10px;
            background-color: #eee;
            background-color: rgba(86,61,124,.15);
            border: 1px solid #ddd;
            border: 1px solid rgba(86,61,124,.2);
        }
        .row {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display:         flex;
            flex-wrap: wrap;
            border: 1px solid #ddd;
        }
        .row:nth-child(even){
            background-color: #f9f9f9;
        }
        .row:nth-child(odd){
            background-color: #ffffff;
        }
        .row > [class*='col-'] {
            display: flex;
            flex-direction: column;
            padding-top: 15px;
            padding-bottom: 15px;
        }
    </style>
</head>
<body>
<div id="menu">
    <select id="fileList">
        <option></option>
        <option value="English/MS_Excel_Plug-in_Installation_Guide">English - MS_Excel_Plug-in_Installation_Guide</option>
        <option value="English/MS_Excel_Plug-in_User_Guide">English - MS_Excel_Plug-in_User_Guide</option>
        <option value="English/MS_Outlook_Plug-in_Installation_Guide_2.x">English - MS_Outlook_Plug-in_Installation_Guide_2.x</option>
        <option value="English/MS_Outlook_Plug-in_User_Guide_2.x">English - MS_Outlook_Plug-in_User_Guide_2.x</option>
        <option value="English/MS_Word_Plug-in_Installation_Guide">English - MS_Word_Plug-in_Installation_Guide</option>
        <option value="English/MS_Word_Plug-in_User_Guide">English - MS_Word_Plug-in_User_Guide</option>
        <option value="English/SugarCRM_Mobile_for_Android_User_Guide">English - SugarCRM_Mobile_for_Android_User_Guide</option>
        <option value="English/SugarCRM_Mobile_for_iOS_User_Guide">English - SugarCRM_Mobile_for_iOS_User_Guide</option>
        <option value="English/Sugar_Enterprise_7.6_Administration_Guide">English - Sugar_Enterprise_7.6_Administration_Guide</option>
        <option value="English/Sugar_Enterprise_7.6_Application_Guide">English - Sugar_Enterprise_7.6_Application_Guide</option>
        <option value="English/Sugar_Enterprise_7.6_Portal_Deployment_User_Guide">English - Sugar_Enterprise_7.6_Portal_Deployment_User_Guide</option>
        <option value="Italian/MS_Excel_Plug-in_Installation_Guide">Italian - MS_Excel_Plug-in_Installation_Guide</option>
        <option value="Italian/MS_Excel_Plug-in_User_Guide">Italian - MS_Excel_Plug-in_User_Guide</option>
        <option value="Italian/MS_Outlook_Plug-in_Installation_Guide_2.x">Italian - MS_Outlook_Plug-in_Installation_Guide_2.x</option>
        <option value="Italian/MS_Outlook_Plug-in_User_Guide_2.x">Italian - MS_Outlook_Plug-in_User_Guide_2.x</option>
        <option value="Italian/MS_Word_Plug-in_Installation_Guide">Italian - MS_Word_Plug-in_Installation_Guide</option>
        <option value="Italian/MS_Word_Plug-in_User_Guide">Italian - MS_Word_Plug-in_User_Guide</option>
        <option value="Italian/SugarCRM_Mobile_for_Android_User_Guide">Italian - SugarCRM_Mobile_for_Android_User_Guide</option>
        <option value="Italian/SugarCRM_Mobile_for_iOS_User_Guide">Italian - SugarCRM_Mobile_for_iOS_User_Guide</option>
        <option value="Italian/Sugar_Enterprise_7.6_Administration_Guide">Italian - Sugar_Enterprise_7.6_Administration_Guide</option>
        <option value="Italian/Sugar_Enterprise_7.6_Application_Guide">Italian - Sugar_Enterprise_7.6_Application_Guide</option>
        <option value="Italian/Sugar_Enterprise_7.6_Portal_Deployment_User_Guide">Italian - Sugar_Enterprise_7.6_Portal_Deployment_User_Guide</option>
    </select>
</div>
<div style="margin-top: 25px;">
    <div class="content col-md-12">
        <div class="row">
            <div class="col-md-1 text-center"><b>ID</b></div>
            <div class="col-md-10" style="border-left: 1px solid #ddd; border-right: 1px solid #ddd;"><b>Text</b></div>
            <div class="col-md-1">&nbsp;</div>
        </div>
    </div>
</div>

<script id="table-template-old" type="text/x-handlebars-template">
    <table class="table table-striped table-bordered">
        <colgroup>
            <col class="col-xs-1">
            <col class="col-xs-10">
            <col class="col-xs-1">
        </colgroup>
        <thead>
        <tr>
            <th class="text-center">ID</th>
            <th>Text</th>
            <th>&nbsp;</th>
        </tr>
        </thead>
        <tbody>
            {{#each selections}}
            <tr {{#if status}}class="success"{{/if}}>
                <td class="text-center">{{id}}</td>
                <td>{{{body_html}}}</td>
                <td class="text-center"><button id="delete" type='button' class='btn btn-danger' data-selection-id='{{id}}'>Delete</button></td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</script>

<script id="table-template" type="text/x-handlebars-template">
    <div class="row">
        <div class="col-md-1 text-center"><b>ID</b></div>
        <div class="col-md-10" style="border-left: 1px solid #ddd; border-right: 1px solid #ddd;"><b>Text</b></div>
        <div class="col-md-1">&nbsp;</div>
    </div>
    {{#each selections}}
    <div class="row">
        <div class="col-md-1 text-center">{{id}}</div>
        <div class="col-md-10" style="border-left: 1px solid #ddd; border-right: 1px solid #ddd;">{{{body_html}}}</div>
        <div class="col-md-1"><button id="delete" type='button' class='btn btn-danger' data-selection-id='{{id}}'>Delete</button></div>
    </div>
    {{/each}}
</script>

<script language="javascript">
    var view, timerId;
    var SelectionsView = Backbone.View.extend({
        initialize: function() {
            this.collection.on("add", this.setStatusNew, this);
            this.collection.on("all", this.render, this);
        },
        el: '.content',
        className: 'table-responsive',
        render: function(e) {
            var data = this.collection.toJSON();
            for(var i=0; i<data.length; i++) {
//                data[i].body_html = data[i].body_html.replace(/\\"/g,'"');
//                data[i].body_html = data[i].body_html.replace(/\\'/g,"'");
//                console.log(data[i].body_html);
            }
//            console.log(this.collection.toJSON());
            var source   = $("#table-template").html();
            var template = Handlebars.compile(source);
            var table = template({ selections: data });
            this.$el.html(table);
            return this;
        },
        events: {
            "click #delete" : "deleteSelection"
        },
        deleteSelection: function(e) {
            var selectionId = $(e.currentTarget).data('selectionId');
            deleteSelection(selectionId, function(result) {
//                console.log("deleted", result, this);
                this.collection.remove(selectionId);
            }.bind(this));
        },
        setStatusNew: function(model) {
            model.set({status: true});
            setTimeout(function() {
                this.set({status: false});
            }.bind(model), 3000);
        },
        destroy: function() {
            this.off();
            this.collection.off();
        }
    });

    var SelectionsCollection = Backbone.Collection.extend({
//        parse: function(response) {
//            console.log(response);
//            return response.results;
//        }
    });

    function getSelections(callback) {
        $.get({
            url: config.apiRoot + "/selections",
            data: {
                "language": language,
                "filename": filename
            },
            dataType: "json",
            success: function(result) {
                callback(result);
            }
        });
    }

    function deleteSelection(id, callback) {
        $.ajax({
            url: config.apiRoot + "/selections/" + id,
            method: 'DELETE',
            dataType: "json",
            success: function(result) {
                callback(result);
            }
        });
    }

    function loadPage(view) {
        getSelections(function(results) {
            view.collection.set(results);
//            console.log(selections);
        });
    }

    $("#fileList").on("change", function(el) {
        var val = $(el.currentTarget).val();
        var path = val.split("/");
        language = path[0];
        filename = path[1];
        var selections = new SelectionsCollection();
        if(view) {
            console.log(view);
            view.destroy();
            delete(view);
        }

        view = new SelectionsView({collection: selections});

        loadPage(view);
//        timerId = setInterval(function() {
//            loadPage(view);
//        }, 3000);
    });

    if(window.location.hash) {
        var hash = window.location.hash.substr(1,window.location.hash.length);
        $("#fileList").val(hash);
        $("#fileList").trigger("change");
    }

</script>
</body>
</html>